name: Nightly Build

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  comprehensive-test:
    name: Comprehensive Testing Suite
    runs-on: macos-14
    
    strategy:
      fail-fast: false
      matrix:
        xcode-version: ['15.4', '16.0']
        destination:
          - 'platform=iOS Simulator,name=iPhone 15'
          - 'platform=iOS Simulator,name=iPhone 15 Pro Max'
          - 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode ${{ matrix.xcode-version }}
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode-version }}
    
    - name: Show Build Environment
      run: |
        xcodebuild -version
        xcrun simctl list devices available
    
    - name: Clean Build
      run: |
        xcodebuild clean \
          -project CrookedSentry.xcodeproj \
          -scheme CrookedSentryTests
    
    - name: Build and Test
      run: |
        xcodebuild test \
          -project CrookedSentry.xcodeproj \
          -scheme CrookedSentryTests \
          -destination '${{ matrix.destination }}' \
          -enableCodeCoverage YES \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          | tee xcodebuild.log \
          | xcpretty && exit ${PIPESTATUS[0]}
    
    - name: Archive Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.xcode-version }}-${{ strategy.job-index }}
        path: xcodebuild.log
        retention-days: 7
    
    - name: Archive Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.xcode-version }}-${{ strategy.job-index }}
        path: ./DerivedData/Logs/Test/*.xcresult
        retention-days: 7

  performance-test:
    name: Performance Testing
    runs-on: macos-14
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
    
    - name: Run Performance Tests
      run: |
        xcodebuild test \
          -project CrookedSentry.xcodeproj \
          -scheme CrookedSentryTests \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro Max' \
          -only-testing:CrookedSentryTests/OperationalMockIntegrationTests/testMockPerformance \
          -only-testing:CrookedSentryTests/SecureAPIClientTests/PerformanceTests \
          -only-testing:CrookedSentryTests/VPNConnectionStateTests/PerformanceTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          | xcpretty && exit ${PIPESTATUS[0]}
    
    - name: Archive Performance Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: ./DerivedData/Logs/Test/*.xcresult
        retention-days: 30

  memory-leak-detection:
    name: Memory Leak Detection
    runs-on: macos-14
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
    
    - name: Run Tests with Instruments
      run: |
        # Run tests with memory debugging enabled
        xcodebuild test \
          -project CrookedSentry.xcodeproj \
          -scheme CrookedSentryTests \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -enableAddressSanitizer YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          | xcpretty && exit ${PIPESTATUS[0]}
    
    - name: Check for Memory Issues
      if: always()
      run: |
        echo "## Memory Analysis" >> $GITHUB_STEP_SUMMARY
        echo "Address Sanitizer enabled for leak detection" >> $GITHUB_STEP_SUMMARY

  notify-results:
    name: Notify Nightly Results
    runs-on: ubuntu-latest
    needs: [comprehensive-test, performance-test, memory-leak-detection]
    if: always()
    
    steps:
    - name: Create Summary
      run: |
        echo "## Nightly Build Results" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Status" >> $GITHUB_STEP_SUMMARY
        echo "- Comprehensive Tests: ${{ needs.comprehensive-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Tests: ${{ needs.performance-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Memory Leak Detection: ${{ needs.memory-leak-detection.result }}" >> $GITHUB_STEP_SUMMARY
